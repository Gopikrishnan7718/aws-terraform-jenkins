pipeline {

    agent {
        docker {
            image 'node:18-alpine'
            args '-u root:root'
        }
    }

    environment {
        APP_NAME        = "node-app"
        ARTIFACT_NAME   = "node-app-${BUILD_NUMBER}.zip"
        AWS_REGION      = "us-east-1"
        S3_BUCKET       = "devops-artifact-bucket-7718"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                  cd app
                  npm install
                '''
            }
        }

        stage('Build') {
            steps {
                sh '''
                  npm run build || echo "No build step defined"
                '''
            }
        }

        stage('Package Artifact') {
            steps {
                sh '''
                  apk add --no-cache zip
                  #zip -r node-app-${BUILD_NUMBER}.zip app
                  zip -r $ARTIFACT_NAME app
                  #zip -r $ARTIFACT_NAME app package.json package-lock.json
                '''
            }
        }

        stage('Upload to S3') {
            steps {
                withAWS(credentials: 'aws-jenkins-creds', region: "${AWS_REGION}") {
                    sh '''
                      set -e
                      
                      apk add --no-cache aws-cli
                      aws s3 cp "$ARTIFACT_NAME" "s3://$S3_BUCKET/$ARTIFACT_NAME"
                      aws s3 cp "s3://$S3_BUCKET/$ARTIFACT_NAME" "s3://$S3_BUCKET/node-app-latest.zip"
                      aws s3api head-object --bucket "$S3_BUCKET" --key "$ARTIFACT_NAME"
                      aws sts get-caller-identity
                      aws s3api head-object --bucket "$S3_BUCKET" --key "$ARTIFACT_NAME"
                      aws s3api get-object-acl --bucket "$S3_BUCKET" --key "$ARTIFACT_NAME" || true

                    '''
                }
            }
        }
    }

    post {
        success {
            echo "Artifact uploaded successfully to S3"
        }
        failure {
            echo "Pipeline failed"
        }
    }
}
        